---
import BaseLayout from '../layouts/BaseLayout.astro';

const postModules = import.meta.glob('./posts/*.md', { eager: true });

const toDate = (value?: string | Date) => {
  if (!value) return undefined;
  if (value instanceof Date) return value;
  if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
    return new Date(`${value}T00:00:00Z`);
  }
  const parsed = new Date(value);
  return Number.isNaN(parsed.valueOf()) ? undefined : parsed;
};

const posts = Object.values(postModules).sort((a, b) => {
  const dateA = toDate(a.frontmatter.pubDate)?.valueOf() ?? 0;
  const dateB = toDate(b.frontmatter.pubDate)?.valueOf() ?? 0;
  return dateB - dateA;
});

const formatDate = (dateInput?: string | Date) => {
  const parsed = toDate(dateInput);
  if (!parsed) {
    return typeof dateInput === "string" ? dateInput : "Date à venir";
  }

  return parsed.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long', day: 'numeric' });
};

const pageTitle = "Articles du blog";
const pageDescription = "Des histoires, des explorations Astro et des tutoriels sélectionnés pour vous.";
---
<BaseLayout {pageTitle} {pageDescription}>
  <section class="blog-intro">
    <p>Parcourez les derniers billets publiés sur AstroBlog. Chaque article mêle expérimentation front-end et retours d'expérience.</p>
  </section>

  <section class="blog-grid" aria-label="Articles récents">
    {posts.map((post) => (
      <article class="blog-card">
        <div class="blog-card__media">
          <img
            src={post.frontmatter.image?.url ?? 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1200&q=80'}
            alt={post.frontmatter.image?.alt ?? post.frontmatter.title}
            loading="lazy"
            decoding="async"
          />
        </div>
        <div class="blog-card__body">
          <p class="blog-card__meta">{formatDate(post.frontmatter.pubDate)}</p>
          <h2>{post.frontmatter.title}</h2>
          <p class="blog-card__description">{post.frontmatter.description}</p>
          <a class="blog-card__link" href={post.url}>
            Lire l'article
            <span aria-hidden="true" class="blog-card__link-icon">→</span>
          </a>
        </div>
      </article>
    ))}
  </section>
</BaseLayout>
